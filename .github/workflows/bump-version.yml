name: Bump Version

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type (ignored if exact_version is set)"
        type: choice
        options:
          - minor
          - major
          - patch
        required: true
      exact_version:
        description: "Exact version to set (e.g. 1.2.3). Takes precedence over version_type."
        type: string
        required: false

jobs:
  bump:
    env:
      VERSION_FILE: "lib/expect_query/version.rb"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Load secret
        id: load_secrets
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb # v3
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.SA_TOKEN_1P }}
          OP_ENV_FILE: ".github/env.tpl"

      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        id: app-token
        with:
          app-id: ${{ steps.load_secrets.outputs.APP_ID }}
          private-key: ${{ steps.load_secrets.outputs.APP_PRIVATE_KEY }}

      - name: Set up Ruby
        uses: ruby/setup-ruby@09a7688d3b55cf0e976497ff046b70949eeaccfd # v1
        with:
          bundler-cache: true

      - name: Determine bump type
        id: bump-type
        run: |
          EXACT="${{ github.event.inputs.exact_version }}"
          if [ -n "$EXACT" ]; then
            echo "type=exact" >> $GITHUB_OUTPUT
            echo "exact=$EXACT" >> $GITHUB_OUTPUT
          else
            echo "type=${{ github.event.inputs.version_type }}" >> $GITHUB_OUTPUT
          fi

      - name: Bump version
        id: bump
        run: |
          CURRENT=$(grep -oP 'VERSION = "\K[^"]+' "$VERSION_FILE")

          BUMP_TYPE="${{ steps.bump-type.outputs.type }}"

          if [ "$BUMP_TYPE" = "exact" ]; then
            NEW_VERSION="${{ steps.bump-type.outputs.exact }}"
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

            case "$BUMP_TYPE" in
              patch)
                PATCH=$((PATCH + 1))
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
            esac

            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          sed -i "s/VERSION = \"${CURRENT}\"/VERSION = \"${NEW_VERSION}\"/" "$VERSION_FILE"

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          bundle config set frozen false
          bundle install

      - name: Create pull request
        id: create-pr
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          token: ${{ steps.app-token.outputs.token }}
          add-paths: |
            Gemfile.lock
            ${{ env.VERSION_FILE }}
          branch: "release/bump-${{ steps.bump.outputs.new }}"
          commit-message: "chore: bump version ${{ steps.bump.outputs.current }} -> ${{ steps.bump.outputs.new }}"
          base: main
          title: "chore: bump version ${{ steps.bump.outputs.current }} -> ${{ steps.bump.outputs.new }}"
          body: |
            Bumps version from `${{ steps.bump.outputs.current }}` to `${{ steps.bump.outputs.new }}` (${{ steps.bump.outputs.type }} bump).

            This PR was auto-generated by the [Bump Version](/.github/workflows/bump-version.yml) workflow.
          labels: "automerge"
          committer: "GitHub Actions <jade@ornelas.io>"
          author: "GitHub Actions <jade@ornelas.io>"

      - name: Enable automerge
        continue-on-error: true
        run: |
          gh pr merge --merge --auto $PR_NUMBER
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pull-request-number }}
