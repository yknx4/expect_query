name: Bump Version

on:
  # Auto-bump patch after every release
  release:
    types: [published]

  # Manual bump for minor, major, or an exact version
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type (ignored if exact_version is set)"
        type: choice
        options:
          - minor
          - major
        required: true
      exact_version:
        description: "Exact version to set (e.g. 1.2.3). Takes precedence over version_type."
        type: string
        required: false

jobs:
  bump:
    env:
      VERSION_FILE: "lib/expect_query/version.rb"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout main
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@09a7688d3b55cf0e976497ff046b70949eeaccfd # v1
        with:
          bundler-cache: true
          cache-version: publish-v1

      - name: Determine bump type
        id: bump-type
        run: |
          EXACT="${{ github.event.inputs.exact_version }}"
          if [ -n "$EXACT" ]; then
            echo "type=exact" >> $GITHUB_OUTPUT
            echo "exact=$EXACT" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "release" ]; then
            echo "type=patch" >> $GITHUB_OUTPUT
          else
            echo "type=${{ github.event.inputs.version_type }}" >> $GITHUB_OUTPUT
          fi

      - name: Bump version
        id: bump
        run: |
          CURRENT=$(grep -oP 'VERSION = "\K[^"]+' "$VERSION_FILE")

          BUMP_TYPE="${{ steps.bump-type.outputs.type }}"

          if [ "$BUMP_TYPE" = "exact" ]; then
            NEW_VERSION="${{ steps.bump-type.outputs.exact }}"
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

            case "$BUMP_TYPE" in
              patch)
                PATCH=$((PATCH + 1))
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
            esac

            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          sed -i "s/VERSION = \"${CURRENT}\"/VERSION = \"${NEW_VERSION}\"/" "$VERSION_FILE"

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          bundle config set frozen false
          bundle install

      - name: Create pull request
        id: create-pr
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6
        with:
          token: ${{ github.token }}
          add-paths: |
            Gemfile.lock
            ${{ env.VERSION_FILE }}
          branch: "release/bump-${{ steps.bump.outputs.new }}"
          commit-message: "chore: bump version ${{ steps.bump.outputs.current }} -> ${{ steps.bump.outputs.new }}"
          base: main
          title: "chore: bump version ${{ steps.bump.outputs.current }} -> ${{ steps.bump.outputs.new }}"
          body: |
            Bumps version from `${{ steps.bump.outputs.current }}` to `${{ steps.bump.outputs.new }}` (${{ steps.bump.outputs.type }} bump).

            This PR was auto-generated by the [Bump Version](/.github/workflows/bump-version.yml) workflow.
          labels: "automerge"
          committer: "GitHub Actions <jade@ornelas.io>"
          author: "GitHub Actions <jade@ornelas.io>"

      - name: Enable automerge
        continue-on-error: true
        run: |
          gh pr merge --merge --auto $PR_NUMBER
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pull-request-number }}
